<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <title>Simple_declarative_view_example</title>

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.js"></script>
  <script type="text/javascript" src="lousy_cells.js" charset="utf-8"></script>
  
</head>

  <body>

    <script type="text/template" id="test-template">
        <h1>{{name}}</h1> 
        <hr/>
        <label> Type something or put the mouse over: 
            <input id="input1" type="text"/>
        </label>
        <div id="result1"></div>
        <div id="msg1" style="display:none;color:green">
            Your mouse is over the input box
        </div>
    </script>

    <div id="container"></div>

    <script type="text/javascript" charset="utf-8">

      // Some shitty templates / view system just for make it work.
      // Dont look at this code, this is only auxiliar bullshit just for
      // avoid adding too mucho complexity to the example with external libs

      function LousyTemplate(id) {
          var text = $('#'+id).text();
          return function() {
              return LousyTemplate.renderer.call(this, text);
          };  
      }
      LousyTemplate.renderer = function (text) {
          var data = this;
          var result = text;

          var placeholders = text.match(/{{.*?}}/g);
          var already_replaced = {}; 
          for (i=0,_len=placeholders.length; i<_len; i++) {
              var placeholder = placeholders[i];
              if (placeholder in already_replaced) continue;
              var prop_name = placeholder.match(/[^{|}]+/);
              var replacement = data[prop_name];
              if (typeof(replacement) == 'function') replacement = replacement.call(this);
              var rep_exp = new RegExp(placeholder, 'g');
              result = result.replace(rep_exp, replacement);
              already_replaced[placeholder] = true;
          }
          return result;
      };

      var T = {test: LousyTemplate('test-template') };


      // The code of the declarative behaivoiur view must be something in this line:

      function SimpleView(params) {
          params || (params = {});
          this.el = params.el;
          this.template = params.template;
          this.behaviour = params.behaviour;
      }
      SimpleView.prototype = {
          render: function() {
              $(this.el).html(this.template());
              this.bind_behaviour();
          },
          bind_behaviour: function() {
              for(var i=0, _len1=this.behaviour.length; i<_len1; i++) {
                  var pattern = this.behaviour[i];
                  var selector = pattern[0];
                  var event = pattern[1];
                  var binding = pattern[2];
                  var cell_or_func = pattern[3];
                  if (binding == 'value') binding = function() { return $(this).val(); };
                  if (event == 'observe') {
                      this.connect_output(selector, binding, cell_or_func);
                  } else {
                      this.connect_input(selector, event, binding, cell_or_func);
                  }
              }
          },
          connect_input: function(selector, event, binding, cell_or_func) {
              var self = this;
              $(this.el).find(selector)[event](function() {
                  var value = binding.call(this);
                  cell_or_func.call(self, value);
              });      
          },
          connect_output: function(selector, binding, cell) {
              var element = $(this.el).find(selector);
              $C(cell).listen(function(value) {
                  if (typeof(binding) == 'function') {
                      binding.call(element, value);
                  } else {
                      element[binding](value);
                  }
              });
          }
      };

      // Once the library is ready, the code for using it should be something like this:

      var SomeView = function(params) {
          params.template = T['test'];
          this.data1 = $C();
          this.data2 = $C();
          this.name = "SIMPLE PSEUDO-DECLARATIVE EXAMPLE";
          this.mix = $C([this.data1, this.data2], function (v1, v2) { 
              return "You typed: '" + v1 + (v2?"' and your mouse is over the input":"'");
          });
          params.behaviour = [
              ['#input1',  'keyup',     'value',                        this.data1],
              ['#input1',  'mouseover', function(){return true;},       this.data2],
              ['#input1',  'mouseout',  function(){return false;},      this.data2],
              ['#result1', 'observe',   function(v){this.html(v);},     this.mix],
              ['#msg1',    'observe',   function(v){this.css('display', v?'block':'none')}, this.data2]
          ];    
          SimpleView.call(this, params);
      };
      SomeView.prototype = new SimpleView();

      var v1 = new SomeView({el: $('#container').get(0)}).render();
    </script>

  </body>

</html>
